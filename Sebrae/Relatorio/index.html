<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerar PDF</title>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background-image: url('https://raw.githubusercontent.com/GabValenca/Prod/main/Sebrae/Relatorio/DRAX/Drax-Wallpaper.jpeg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }
      @media print {
        #form-container {
          display: none;
        }
      }
    </style>
    <style>
      @media print {
        #form-container {
          display: none;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 flex">
    <!-- Sidebar -->
    <aside class="w-32 h-screen text-white fixed flex flex-col items-center p-4">
      <div class="text-4xl ml-4">Gerador de PDF üìÑ</div>
      <nav class="mt-6 w-full">
        <ul class="space-y-4 text-lg">
          <li><a href="#" class="block p-2 rounded hover:bg-gray-700">In√≠cio</a></li>
          <li><a href="#" class="block p-2 rounded hover:bg-gray-700">Calculadora</a></li>
          <li><a href="#" class="block p-2 rounded hover:bg-gray-700">Configura√ß√µes</a></li>
        </ul>
        <button id="downloadPdf" class="mt-6 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700">
          Baixar PDF
        </button>
      </nav>
    </aside>

    <!-- Formul√°rio de Entrada (Vue) -->
    <div id="app" class="ml-40 p-6 bg-white shadow-lg rounded-lg">
      <h2 class="text-xl font-semibold mb-4">Configura√ß√£o do Documento</h2>
      <div id="form-container" class="grid grid-cols-1 gap-4">
        <!-- Campo de sele√ß√£o de perfil -->
        <div>
          <label class="block text-sm font-medium">Perfil</label>
          <select v-model="selectedProfile" class="w-full border rounded p-2">
            <option value="VILTI">VILTI</option>
            <option value="Drax">Drax</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Title</label>
          <input type="text" id="title" v-model="title" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Company Logo</label>
          <input type="file" id="companyLogo" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Client Logo</label>
          <input type="file" id="clientLogo" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Client Name</label>
          <input type="text" id="clientName" v-model="clientName" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Project</label>
          <input type="text" id="project" v-model="project" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Owner</label>
          <input type="text" id="owner" v-model="owner" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Footer</label>
          <input type="text" id="footer" v-model="footer" class="w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Arquivo CSV</label>
          <input type="file" id="csvFile" class="w-full border rounded p-2" />
        </div>
      </div>
    </div>

    <script>
      // Fun√ß√£o para formatar n√∫meros com separador de milhares (ex.: 9090 ‚Üí "9.090")
      // Aqui N√ÉO alteramos a fun√ß√£o em si; a exce√ß√£o ser√° aplicada no momento de usar essa fun√ß√£o.
      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }
      
      document.getElementById("downloadPdf").addEventListener("click", async function () {
        try {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();

          // Vari√°veis para o sum√°rio (TOC)
          let tocItems = [];
          let contentPageNumber = 1;

          function fixEncoding(str) {
            return str
              .replace(/Quantidade/g, "Qtd.")
              .replace(/DLP /g, "Total")
              .replace(/Auditoria/g, "")
              .replace(/Conte‚àö√â¬¨‚à´do/g, "Conte√∫do")
              .replace(/Destinat‚àö√â¬¨¬∞rios/g, "Destinat√°rios")
              .replace(/Destinat√É¬°rios/g, "Destinat√°rios")
              .replace(/Amea√É¬ßas/g, "Amea√ßas")
              .replace(/Conte&uacuteo/g, "Conte√∫do")
              .replace(/Conte√É¬∫do/g, "Conte√∫do")
              .replace(/Prov√É¬°vel/g, "Prov√°vel")
              .replace(/Prov‚àö√â¬¨¬∞vel/g, "Prov√°vel")
              .replace(/V‚àö√â¬¨‚â†rus/g, "V√≠rus")
              .replace(/V√É-rus/g, "V√≠rus")
              .replace(/V√£-rus/g, "V√≠rus")
              .replace(/V√Érus/g, "V√≠rus")
              .replace(/Apari√É¬ß√É¬£o/g, "Apari√ß√£o")
              .replace(/Email Impostor/g, "Impostor")
              .replace(/'/g, "");
          }

          // Paleta de cores para os gr√°ficos
          const colorPalette = [
            "rgba(255, 99, 132, 0.5)",
            "rgba(54, 162, 235, 0.5)",
            "rgba(255, 206, 86, 0.5)",
            "rgba(75, 192, 192, 0.5)",
            "rgba(153, 102, 255, 0.5)",
            "rgba(255, 159, 64, 0.5)",
            "rgba(199, 199, 199, 0.5)",
            "rgba(83, 102, 255, 0.5)",
            "rgba(255, 102, 102, 0.5)",
            "rgba(102, 255, 102, 0.5)",
            "rgba(102, 102, 255, 0.5)"
          ];

          // Obt√©m os valores dos inputs
          const titleInput = fixEncoding(document.getElementById("title").value || "RELAT√ìRIO MENSAL");
          const clientName = fixEncoding(document.getElementById("clientName").value || "N/A");
          const project = fixEncoding(document.getElementById("project").value || "N/A");
          const owner = fixEncoding(document.getElementById("owner").value || "N/A");
          const footer = fixEncoding(document.getElementById("footer").value || "N/A");
          const currentDate = new Date().toLocaleDateString();
          const csvFile = document.getElementById("csvFile").files[0];

          // Recupera a cor do cabe√ßalho definida pelo perfil selecionado
          const currentProfile = app._instance.data.selectedProfile;
          const headerColor = app._instance.data.profiles[currentProfile].headerColor;

          // --- Processamento do Company Logo ---
          let companyLogoData = null;
          let companyLogoDimensions = null;
          const companyLogoInput = document.getElementById("companyLogo").files[0];
          if (companyLogoInput) {
            await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                  const aspectRatio = img.width / img.height;
                  let width = 40, height = 20;
                  if (img.width > img.height) {
                    height = width / aspectRatio;
                  } else {
                    width = height * aspectRatio;
                  }
                  companyLogoData = event.target.result;
                  companyLogoDimensions = { width, height };
                  pdf.addImage(companyLogoData, "PNG", 10, 10, width, height);
                  resolve();
                };
                img.src = event.target.result;
              };
              reader.onerror = reject;
              reader.readAsDataURL(companyLogoInput);
            });
          } else if (!companyLogoInput && currentProfile === "VILTI" && app._instance.data.profiles.VILTI.companyLogo) {
            const defaultCompanyUrl = app._instance.data.profiles.VILTI.companyLogo;
            const response = await fetch(defaultCompanyUrl);
            const blob = await response.blob();
            await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = function (event) {
                companyLogoData = event.target.result;
                const img = new Image();
                img.onload = function () {
                  const aspectRatio = img.width / img.height;
                  let width = 40, height = 20;
                  if (img.width > img.height) { height = width / aspectRatio; } 
                  else { width = height * aspectRatio; }
                  companyLogoDimensions = { width, height };
                  pdf.addImage(companyLogoData, "PNG", 10, 10, width, height);
                  resolve();
                };
                img.onerror = reject;
                img.src = companyLogoData;
              };
              reader.onerror = reject;
              reader.readAsDataURL(blob);
            });
          }

          // --- Processamento do Client Logo ---
          let clientLogoData = null;
          let clientLogoDimensions = null;
          const clientLogoInput = document.getElementById("clientLogo").files[0];
          if (clientLogoInput) {
            await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                  let width = 50, height = 30;
                  const aspectRatio = img.width / img.height;
                  if (img.width > img.height) { height = width / aspectRatio; }
                  else { width = height * aspectRatio; }
                  clientLogoData = event.target.result;
                  clientLogoDimensions = { width, height };
                  pdf.addImage(clientLogoData, "PNG", (pageWidth - 50) / 2, pageHeight / 2, 50, 30);
                  resolve();
                };
                img.src = event.target.result;
              };
              reader.onerror = reject;
              reader.readAsDataURL(clientLogoInput);
            });
          } else if (!clientLogoInput && currentProfile === "VILTI" && app._instance.data.profiles.VILTI.clientLogo) {
            const defaultClientUrl = app._instance.data.profiles.VILTI.clientLogo;
            const response = await fetch(defaultClientUrl);
            const blob = await response.blob();
            await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = function (event) {
                clientLogoData = event.target.result;
                const img = new Image();
                img.onload = function () {
                  let width = 50, height = 30;
                  const aspectRatio = img.width / img.height;
                  if (img.width > img.height) { height = width / aspectRatio; } 
                  else { width = height * aspectRatio; }
                  clientLogoDimensions = { width, height };
                  pdf.addImage(clientLogoData, "PNG", (pageWidth - 50) / 2, pageHeight / 2, 50, 30);
                  resolve();
                };
                img.onerror = reject;
                img.src = event.target.result;
              };
              reader.onerror = reject;
              reader.readAsDataURL(blob);
            });
          }
          // Fim do processamento dos logos

          // Fun√ß√£o para adicionar uma nova p√°gina com o company logo (para as p√°ginas de conte√∫do)
          function addPageWithLogo() {
            pdf.addPage();
            if (companyLogoData && companyLogoDimensions) {
              pdf.addImage(companyLogoData, "PNG", 10, 10, companyLogoDimensions.width, companyLogoDimensions.height);
            }
          }

          // ========================
          // P√ÅGINA 1: CAPA
          // ========================
          pdf.setFont("helvetica", "bold");
          pdf.setFontSize(35);
          pdf.text(`RELAT√ìRIO MENSAL`, pageWidth / 2, pageHeight / 2 - 60, { align: "center" });
          pdf.text(`DE AN√ÅLISE`, pageWidth / 2, pageHeight / 2 - 40, { align: "center" });
          pdf.text(titleInput, pageWidth / 2, pageHeight / 2 - 20, { align: "center" });
          pdf.setFont("helvetica", "normal");
          pdf.setFontSize(10);
          pdf.text(`Cliente: `, 20, pageHeight - 50);
          pdf.text(`${clientName}`, 45, pageHeight - 50);
          pdf.text(`Data: `, 20, pageHeight - 45);
          pdf.text(`${currentDate}`, 45, pageHeight - 45);
          pdf.text(`Projeto: `, 20, pageHeight - 40);
          pdf.text(`${project}`, 45, pageHeight - 40);
          pdf.text(`Respons√°vel:`, 20, pageHeight - 35);
          pdf.text(`${owner}`, 45, pageHeight - 35);

          // ========================
          // P√ÅGINA 2: SUM√ÅRIO
          // ========================
          pdf.addPage(); // Cria a p√°gina de sum√°rio (p√°gina 2)
          if (companyLogoData && companyLogoDimensions) {
            pdf.addImage(companyLogoData, "PNG", 10, 10, companyLogoDimensions.width, companyLogoDimensions.height);
          }
          pdf.setFont("helvetica", "bold");
          pdf.setFontSize(20);
          pdf.text("Sum√°rio", pageWidth / 2, 30, { align: "center" });
          // O conte√∫do do sum√°rio (TOC) ser√° preenchido posteriormente

          // ========================
          // P√ÅGINA 3: INTRODU√á√ÉO
          // ========================
          tocItems.push({ title: "Introdu√ß√£o", page: contentPageNumber });
          contentPageNumber++;
          addPageWithLogo(); // Cria a p√°gina de Introdu√ß√£o (p√°gina 3)
          pdf.setFont("helvetica", "bold");
          pdf.setFontSize(20);
          pdf.text("MailInspector", pageWidth / 2, 30, { align: "center" });
          pdf.setFont("helvetica", "normal");
          pdf.setFontSize(12);
          const introText10 = `1. INTRODU√á√ÉO`;
          const introText111 = `    MailInspector √© uma ferramenta avan√ßada de an√°lise de emails que permite a inspe√ß√£o detalhada de campanhas, identifica√ß√£o de spams, e monitoramento de performance de mensagens.`;
          const introText112 = `  Este relat√≥rio apresenta a an√°lise detalhada dos e-mails enviados e recebidos pelo ${clientName}, utilizando a ferramenta MailInspector da HSC atrav√©s do suporte de sustenta√ß√£o da ${footer}. O objetivo desta an√°lise √© verificar a conformidade com boas pr√°ticas de seguran√ßa, identificar poss√≠veis vulnerabilidades e avaliar a reputa√ß√£o dos remetentes e dom√≠nios.`;
          const introText113 = `  A ferramenta MailInspector permite detectar falhas de autentica√ß√£o, avaliar a integridade das mensagens e identificar potenciais amea√ßas, como phishing, spam e ataques baseados em e-mails.`;
          const introText114 = `2. METODOLOGIA\r
        Para garantir uma an√°lise completa, foram adotados os seguintes crit√©rios:`; 
          const introText12 = `2.1. An√°lise de Autentica√ß√£o (SPF, DKIM e DMARC)`;    
          const introText13 = `SPF (Sender Policy Framework): Verifica se o e-mail foi enviado de um servidor autorizado pelo dom√≠nio.`; 
          const introText14 = `DKIM (DomainKeys Identified Mail): Avalia a assinatura digital do e-mail para garantir a autenticidade da mensagem.`; 
          const introText15 = `DMARC (Domain-based Message Authentication, Reporting & Conformance): Determina a pol√≠tica do dom√≠nio para tratamento de e-mails falhos em autentica√ß√£o`; 
          const introText16 = `2.2. An√°lise de Cabe√ßalhos`; 
          const introText17 = `Verifica√ß√£o da estrutura dos e-mails para identificar inconsist√™ncias e manipula√ß√µes.`; 
          const introText18 = `Detec√ß√£o de redirecionamentos suspeitos e altera√ß√µes no fluxo do e-mail`; 
          const introText19 = `2.3. Reputa√ß√£o do Remetente e Dom√≠nio`; 
          const introText20 = `Consulta a listas de reputa√ß√£o de IPs e dom√≠nios para identificar poss√≠veis problemas.`; 
          const introText21 = `Verifica√ß√£o em blacklists p√∫blicas e privadas.`; 
          const introText22 = `2.4. Detec√ß√£o de Amea√ßas (Phishing, Spam e Malware)`; 
          const introText23 = `Identifica√ß√£o de palavras-chave e padr√µes t√≠picos de ataques de phishing e spam.`; 
          const introText24 = `Verifica√ß√£o de links maliciosos e anexos suspeitos.`; 
          const introText25 = `Avalia√ß√£o de tentativas de spoofing e engenharia social.`; 

          pdf.text(introText10, 20, 50, { maxWidth: pageWidth - 40 });
          pdf.text(introText111, 20, 60, { maxWidth: pageWidth - 40, align: "justify" });
          pdf.text(introText112, 20, 80, { maxWidth: pageWidth - 40, align: "justify" });
          pdf.text(introText113, 20, 110, { maxWidth: pageWidth - 40, align: "justify" });
          pdf.text(introText114, 20, 135, { maxWidth: pageWidth - 40 });
          pdf.text(introText12, 20, 150, { maxWidth: pageWidth - 40 });
          pdf.text(introText13, 25, 155, { maxWidth: pageWidth - 45, align: "justify" });
          pdf.text(introText14, 25, 165, { maxWidth: pageWidth - 45, align: "justify" });
          pdf.text(introText15, 25, 175, { maxWidth: pageWidth - 45, align: "justify" });
          pdf.text(introText16, 20, 190, { maxWidth: pageWidth - 40 });
          pdf.text(introText17, 25, 195, { maxWidth: pageWidth - 45, align: "justify" });
          pdf.text(introText18, 25, 200, { maxWidth: pageWidth - 45, align: "justify" });
          pdf.text(introText19, 20, 210, { maxWidth: pageWidth - 40 });
          pdf.text(introText20, 25, 215, { maxWidth: pageWidth - 45, align: "justify" });
          pdf.text(introText21, 25, 220, { maxWidth: pageWidth - 45, align: "justify" });
          pdf.text(introText22, 20, 230, { maxWidth: pageWidth - 40 });
          pdf.text(introText23, 25, 235, { maxWidth: pageWidth - 45, align: "justify" });
          pdf.text(introText24, 25, 240, { maxWidth: pageWidth - 45, align: "justify" });
          pdf.text(introText25, 25, 245, { maxWidth: pageWidth - 45, align: "justify" });

          // ========================
          // Processamento do CSV para gr√°ficos e tabelas
          // ========================
          if (csvFile) {
            await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = async function (event) {
                try {
                  const csvText = fixEncoding(event.target.result);
                  const lines = csvText.split(/\r?\n/);
                  const segments = [];
                  let currentSegment = [];
                  lines.forEach(line => {
                    if (line.trim() === "") {
                      if (currentSegment.length > 0) {
                        segments.push(currentSegment);
                        currentSegment = [];
                      }
                    } else {
                      currentSegment.push(line);
                    }
                  });
                  if (currentSegment.length > 0) segments.push(currentSegment);

                  // Mapeamento dos gr√°ficos
                  const chartMapping = [
                    { title: "Volume de Mensagens por Data", expectedColumns: 19, type: "line" },
                    { title: "Principais Destinat√°rios de SPAM (por Email)", expectedColumns: 2, type: "bar" },
                    { title: "Principais Destinat√°rios de SPAM (por Dom√≠nio)", expectedColumns: 2, type: "bar" },
                    { title: "Top E-mail Relays", expectedColumns: 2, type: "line" },
                    { title: "Top Remetentes por Quantidade (por Email)", expectedColumns: 13, type: "bar" },
                    { title: "Top Remetentes por Quantidade (por Dom√≠nio)", expectedColumns: 13, type: "bar" },
                    { title: "Top Destinat√°rio por Volume (por Email)", expectedColumns: 3, type: "bar" },
                    { title: "Top Remetentes por Volume", expectedColumns: 3, type: "bar" },
                    { title: "Top Destinat√°rio por Quantidade (por Dom√≠nio)", expectedColumns: 3, type: "bar" },
                    { title: "Top Destinat√°rio por Quantidade (por Email)", expectedColumns: 3, type: "bar" },
                    { title: "Top Destinat√°rio por Volume (por Dom√≠nio)", expectedColumns: 2, type: "doughnut" },
                    { title: "Top Destinat√°rio por Volume (por Email)", expectedColumns: 2, type: "bar" },
                    { title: "Principais Remetentes de SPAM (por Dom√≠nio)", expectedColumns: 2, type: "doughnut" },
                    { title: "Relat√≥rio de V√≠rus", expectedColumns: 3, type: "doughnut" }
                  ];

                  const titleFontOptions = {
                    font: { family: "helvetica", size: 20, weight: "normal" },
                    color: "black"
                  };
                  const chartFontOptions = {
                    font: { family: "helvetica", size: 8, weight: "normal" },
                    color: "black"
                  };

                  // Para cada segmento (gr√°fico)
                  for (let i = 0; i < Math.min(segments.length, chartMapping.length); i++) {
                    const segment = segments[i];
                    if (segment.length < 2) {
                      console.warn(`Segmento ${i+1} n√£o possui dados suficientes.`);
                      continue;
                    }
                    const headerCells = segment[0].split(";").map(cell => fixEncoding(cell.trim()));
                    const tableData = [];
                    for (let j = 1; j < segment.length; j++) {
                      if (segment[j].trim() === "") continue;
                      const rowCells = segment[j].split(";").map(cell => fixEncoding(cell.trim()));
                      tableData.push(rowCells);
                    }

                    // Se for o gr√°fico "Volume de Mensagens por Data", aplicar modifica√ß√µes:
                    if (chartMapping[i].title === "Volume de Mensagens por Data") {
                      // Verifica se h√° pelo menos 3 colunas no cabe√ßalho e em cada linha
                      if (headerCells.length > 2) {
                        headerCells.splice(2, 1);
                      } else {
                        console.warn("Cabe√ßalho com menos de 3 colunas:", headerCells);
                      }
                      tableData.forEach(row => {
                        if (row.length > 2) {
                          row.splice(2, 1);
                        } else {
                          console.warn("Linha com menos de 3 colunas:", row);
                        }
                      });

                      // Formata a primeira coluna (exceto se o valor for "Total")
                      tableData.forEach(row => {
                        if (row[0] && row[0] !== "Total") {
                          let dateObj = new Date(row[0]);
                          if (!isNaN(dateObj.getTime())) {
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const year = dateObj.getFullYear();
                            row[0] = `${day}/${month}/${year}`;
                          }
                        }
                      });
                    }

                    // Remo√ß√µes espec√≠ficas para outros gr√°ficos (exemplos)
                    if (chartMapping[i].title === "Top E-mail Relays") {
                      // Removemos a quarta coluna (√≠ndice 3)
                      if (headerCells.length > 3) {
                        headerCells.splice(3, 1);
                      } else {
                        console.warn("Cabe√ßalho insuficiente para 'Top E-mail Relays'", headerCells);
                      }
                      tableData.forEach(row => {
                        if (row.length > 3) {
                          row.splice(3, 1);
                        } else {
                          console.warn("Linha insuficiente em 'Top E-mail Relays'", row);
                        }
                      });
                    }

                    if (chartMapping[i].title === "Relat√≥rio de V√≠rus") {
                      // Removemos a segunda coluna (√≠ndice 1)
                      if (headerCells.length > 1) {
                        headerCells.splice(1, 1);
                      } else {
                        console.warn("Cabe√ßalho insuficiente para 'Relat√≥rio de V√≠rus'", headerCells);
                      }
                      tableData.forEach(row => {
                        if (row.length > 1) {
                          row.splice(1, 1);
                        } else {
                          console.warn("Linha insuficiente em 'Relat√≥rio de V√≠rus'", row);
                        }
                      });
                    }

                    if (
                      chartMapping[i].title === "Top Remetentes por Quantidade (por Email)" ||
                      chartMapping[i].title === "Top Remetentes por Quantidade (por Dom√≠nio)" ||
                      chartMapping[i].title === "Top Destinat√°rio por Volume (por Email)" ||
                      chartMapping[i].title === "Top Remetentes por Volume" ||
                      chartMapping[i].title === "Top Destinat√°rio por Quantidade (por Dom√≠nio)" ||
                      chartMapping[i].title === "Top Destinat√°rio por Quantidade (por Email)" ||
                      chartMapping[i].title === "Top Destinat√°rio por Volume (por Dom√≠nio)"
                    ) {
                      // Remove a terceira coluna (√≠ndice 2)
                      if (headerCells.length > 2) {
                        headerCells.splice(2, 1);
                      } else {
                        console.warn("Cabe√ßalho com menos de 3 colunas:", headerCells);
                      }
                      tableData.forEach(row => {
                        if (row.length > 2) {
                          row.splice(2, 1);
                        } else {
                          console.warn("Linha com menos de 3 colunas:", row);
                        }
                      });
                    }

                    // Se for o primeiro segmento, adiciona a linha de totais (exceto para charts de outros tipos)
                    let chartTableData;
                    if (i === 0) {
                      const totals = [];
                      totals[0] = "Total";
                      for (let col = 1; col < headerCells.length; col++) {
                        let sum = 0;
                        tableData.forEach(row => {
                          sum += Number(row[col]) || 0;
                        });
                        totals[col] = sum;
                      }
                      tableData.push(totals);
                      chartTableData = tableData.slice(0, -1);
                    } else {
                      chartTableData = tableData;
                    }

                    let chartData = {};
                    if (chartMapping[i].type === "doughnut") {
                      if (
                        chartMapping[i].title === "Top Destinat√°rio por Volume (por Dom√≠nio)" ||
                        chartMapping[i].title === "Principais Remetentes de SPAM (por Dom√≠nio)" ||
                        chartMapping[i].title === "Relat√≥rio de V√≠rus"
                      ) {
                        const labels = tableData.map(row => row[0]);
                        const dataArr = tableData.map(row => Number(row[1]));
                        chartData = {
                          labels: labels,
                          datasets: [{
                            label: chartMapping[i].title,
                            data: dataArr,
                            backgroundColor: colorPalette.slice(0, labels.length),
                            borderWidth: 1
                          }]
                        };
                      } else {
                        const doughnutLabels = headerCells.slice(1);
                        const doughnutData = tableData[0].slice(1).map(v => Number(v));
                        chartData = {
                          labels: doughnutLabels,
                          datasets: [{
                            label: chartMapping[i].title,
                            data: doughnutData,
                            backgroundColor: colorPalette.slice(0, doughnutLabels.length),
                            borderWidth: 1
                          }]
                        };
                      }
                    } else {
                      const xLabels = chartTableData.map(row => row[0]);
                      const datasets = [];
                      for (let col = 1; col < headerCells.length; col++) {
                        const dataArr = chartTableData.map(row => Number(row[col]));
                        const datasetColor = colorPalette[(col - 1) % colorPalette.length];
                        datasets.push({
                          label: headerCells[col],
                          data: dataArr,
                          backgroundColor: datasetColor,
                          borderColor: datasetColor.replace("0.5", "1"),
                          borderWidth: 1
                        });
                      }
                      chartData = { labels: xLabels, datasets: datasets };
                    }

                    // Registra o t√≠tulo do gr√°fico no sum√°rio e incrementa o contador de p√°ginas
                    tocItems.push({ title: chartMapping[i].title, page: contentPageNumber });
                    contentPageNumber++;

                    // Cria o gr√°fico usando Chart.js
                    const canvas = document.createElement("canvas");
                    canvas.width = 600;
                    canvas.height = 420;
                    canvas.style.position = "absolute";
                    canvas.style.left = "-9999px";
                    document.body.appendChild(canvas);
                    const ctx = canvas.getContext("2d");

                    await new Promise((chartResolve) => {
                      const options = {
                        responsive: false,
                        maintainAspectRatio: false,
                        animation: {
                          duration: 100,
                          onComplete: function() {
                            try {
                              const imageURL = chartInstance.toBase64Image();
                              addPageWithLogo();
                              pdf.addImage(imageURL, "PNG", 15, 25, 180, 120);
                              // *** Aqui aplicamos a exce√ß√£o para a coluna 0 de "Volume de Mensagens por Data"
                              const formattedTableData = tableData.map((row) =>
                                row.map((cell, colIndex) => {
                                    // Se for "Volume de Mensagens por Data" e a coluna for a 0, retorna sem formata√ß√£o
                                    if (chartMapping[i].title === "Volume de Mensagens por Data" && colIndex === 0) {
                                    return cell;
                                    }
                                    // Se for "Top E-mail Relays" e a coluna for a 1 (segunda coluna), retorna sem formata√ß√£o
                                    if (chartMapping[i].title === "Top E-mail Relays" && colIndex === 1) {
                                    return cell;
                                    }
                                    const n = parseFloat(cell);
                                    return isNaN(n) ? cell : formatNumber(n);
                                })
                                );

                              pdf.autoTable({
                                startY: 150,
                                head: [headerCells],
                                body: formattedTableData,
                                theme: "grid",
                                styles: { fontSize: 5 },
                                headStyles: { fillColor: headerColor },
                                didParseCell: function(data) {
                                  if (
                                    chartMapping[i].title === "Volume de Mensagens por Data" &&
                                    data.row.index === tableData.length - 1
                                  ) {
                                    data.cell.styles.fillColor = [230, 230, 230];
                                    data.cell.styles.textColor = [0, 0, 0];
                                    data.cell.styles.fontStyle = "bold";
                                  }
                                }
                              });
                            } catch (err) {
                              console.error("Erro ao gerar gr√°fico/tabela:", err);
                            }
                            document.body.removeChild(canvas);
                            chartResolve();
                          }
                        },
                        plugins: {
                          title: {
                            display: true,
                            text: chartMapping[i].title,
                            ...titleFontOptions
                          },
                          legend: {
                            labels: { ...chartFontOptions }
                          }
                        }
                      };

                      if (chartMapping[i].type !== "doughnut") {
                        options.scales = {
                          x: { ticks: { ...chartFontOptions } },
                          y: { beginAtZero: true, ticks: { ...chartFontOptions } }
                        };
                      }

                      const chartInstance = new Chart(ctx, {
                        type: chartMapping[i].type,
                        data: chartData,
                        options: options
                      });
                    });
                  }
                  resolve();
                } catch (err) {
                  console.error("Erro no processamento do CSV:", err);
                  reject(err);
                }
              };
              reader.onerror = function (e) {
                console.error("Erro ao ler o arquivo CSV", e);
                reject(e);
              };
              reader.readAsText(csvFile);
            });
          }

          // --- Adiciona rodap√© e numera√ß√£o de p√°gina em cada p√°gina ---
          const totalPages = pdf.internal.getNumberOfPages();
          for (let i = 1; i <= totalPages; i++) {
            pdf.setPage(i);
            pdf.setFontSize(8);
            pdf.text(footer, 8, pageHeight - 10);
            pdf.text(`https://${footer}.com.br`, 8, pageHeight - 5);
            pdf.text(`${i}`, pageWidth - 10, pageHeight - 5, { align: "right" });
          }

          // --- Preenche o Sum√°rio (p√°gina 2) com os itens do TOC ---
          pdf.setPage(2);
          pdf.setFont("helvetica", "normal");
          pdf.setFontSize(12);
          let tocY = 40;
          tocItems.forEach(item => {
            pdf.text(item.title, 20, tocY);
            pdf.text(String(item.page), pageWidth - 20, tocY, { align: "right" });
            tocY += 10;
          });

          // --- Salva o PDF ---
          pdf.save(`(${project}) ${footer} - Relatorio Mensal MailInspector`);
        } catch (err) {
          console.error("Erro ao gerar o PDF:", err);
        }
      });

      // Configura√ß√£o do Vue (com valores pr√©-definidos)
      const app = Vue.createApp({
        data() {
          return {
            selectedProfile: "VILTI",
            profiles: {
              VILTI: {
                companyLogo: "https://raw.githubusercontent.com/GabValenca/Prod/9360aafcd7cd663118dd511b2cc83bf99a7615a5/Sebrae/Relatorio/VILTI/Transparente.png",
                clientLogo: "https://raw.githubusercontent.com/GabValenca/Prod/9360aafcd7cd663118dd511b2cc83bf99a7615a5/Sebrae/Relatorio/VILTI/Sebrae.png",
                clientName: "SEBRAE",
                project: "SEBRAE",
                owner: "Gleisson Farias",
                title: "MailInspector (HSC)",
                footer: "VILTI",
                headerColor: [0, 102, 204]
              },
              Drax: {
                companyLogo: "https://raw.githubusercontent.com/GabValenca/Prod/9360aafcd7cd663118dd511b2cc83bf99a7615a5/Sebrae/Relatorio/DRAX/logo-versao-cores.png",
                clientName: "Teste",
                project: "Teste",
                owner: "Gleisson Farias",
                title: "MailInspector (HSC)",
                footer: "DraxTec",
                headerColor: [204, 0, 0]
              }
            },
            clientName: "SEBRAE",
            project: "SEBRAE",
            owner: "Gabriel S Valen√ßa",
            title: "MailInspector (HSC)",
            footer: "VILTI"
          };
        },
        watch: {
          selectedProfile(newProfile) {
            const profile = this.profiles[newProfile];
            if (profile) {
              this.clientName = profile.clientName;
              this.project = profile.project;
              this.owner = profile.owner;
              this.title = profile.title;
              this.footer = profile.footer;
            }
          }
        }
      });
      app.mount("#app");

      // Fun√ß√£o auxiliar para adicionar imagem (caso necess√°rio)
      function addImageToPDF(file, x, y, maxWidth, maxHeight) {
        return new Promise((resolve, reject) => {
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              const img = new Image();
              img.src = event.target.result;
              img.onload = function () {
                const aspectRatio = img.width / img.height;
                let width = maxWidth;
                let height = maxHeight;
                if (img.width > img.height) {
                  height = width / aspectRatio;
                } else {
                  width = height * aspectRatio;
                }
                pdf.addImage(event.target.result, "PNG", x, y, width, height);
                resolve();
              };
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
          } else {
            resolve();
          }
        });
      }
    </script>
  </body>
</html>
